# -*- coding: utf-8 -*-
"""Create_multi-turn_convo_dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1br8-b6BRqTHddGMygxQNjUINw-tqOVGf
"""

!pip install openai pandas tqdm

import os
import pandas as pd
import openai
from tqdm import tqdm
df = pd.read_csv("***")

# Set your OpenAI API key (safest via environment variable)


df = pd.read_json("/content/medical_meadow_medqa.json")
print(f"\n‚úÖ Loaded DataFrame with {len(df)} rows.")
print("\nüîç DataFrame Preview:")
df.head()

import os
from openai import OpenAI

client = OpenAI(

    api_key="***")

Set_up_cases="""Read the following patient scenario question, extract out the patient's chief complaint.  If a chief complaint is not provided, then make one up.  Your response should include the patient's age, sex, and chief complaint in 10 words or less.  For example: "30 year old female presenting with abdominal pain".  If there is no patient scenario, say "skipped".  Here is the provided patient scenario:"""
Set_up_details="""Read the following patient scenario question, extract out the history items that would be important to an standardized patient (actor) playing the patient such as history of present illness, past medical history,  social history, family history, etc.  Do not use medical terms, change the description to layperson terms.  DO NOT STATE OR ELUDE TO A FINAL DIAGNOSIS.  You can extrapolate signs/symptoms a little if needed.  Your response should look like instruction to the actor and should look like the following format: "You are a patient who has had pain for 10 days.  You describe the pain as dull.  The pain is 10/10.  You feel the pain radiate to your jaw. etc."  Here is the provided patient scenario:"""
Set_up_diagnosis="""Read the following patient scenario question, determine the patient's diagnosis based on the provided history.  Do not include any treatment or management decisions.  Respond in 5 words or less. Be as specific as possible  For example: "Uncomplicated Urinary Tract Infection" or "Acute Myocardial Infarction".  It can also be helpful to view the final answer of the question:"""
End = """  Here is the provided patient scenario:"""
original_Set_up_diagnosis="""Read the following patient scenario question, determine the patient's diagnosis based on the provided history.  Do not include any treatment or management decisions.  Respond in 5 words or less. Be as specific as possible  For example: "Uncomplicated Urinary Tract Infection" or "Acute Myocardial Infarction".  Here is the provided patient scenario:"""

# Function to call the OpenAI API
def case_query_gpt(prompt):
      response = client.responses.create(
      model="gpt-4o",
      instructions="You are helpful assistant.",
      input=Set_up_cases+prompt,
       )
      return response.output_text

def diagnosis_query_gpt(prompt):
      response = client.responses.create(
      model="gpt-4o",
      instructions="You are helpful assistant.",
      input=original_Set_up_diagnosis+prompt,
       )
      return response.output_text


# Apply GPT to each row in the DataFrame

for i in range(10,len(df)):
  try:
    print(i)
    df["diagnosis"][i] = diagnosis_query_gpt(df["details"][i])
    df.to_csv("/content/drive/MyDrive/GRPO/full_scenario_results2.csv", index=False)

  except:
    continue
# Save or inspect result

df.head(35)

